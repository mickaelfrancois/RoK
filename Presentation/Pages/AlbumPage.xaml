<?xml version="1.0" encoding="utf-8"?>
<Page x:Class="Rok.Pages.AlbumPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:Rok.Pages"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:common="using:Rok.Commons"
      xmlns:tracks="using:Rok.Logic.ViewModels.Tracks"
      xmlns:controls="using:CommunityToolkit.WinUI.Controls"
      x:Name="albumPage"
      mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <!--Height="{ThemeResource headerRowHeight}" />-->
            <RowDefinition x:Name="headerRow"
                           Height="200" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Grid.Background>
            <SolidColorBrush Color="{ThemeResource CardBackgroundFillColorDefault}"
                             Opacity="{StaticResource headerBackgroundOpacity}" />
        </Grid.Background>

        <Image x:Name="backdrop"
               Grid.RowSpan="2"
               Source="{x:Bind ViewModel.Backdrop,Mode=OneWay}"
               Opacity="{StaticResource headerBackdropOpacity}"
               Style="{StaticResource headerBackdrop}"
               Stretch="UniformToFill"
               IsHitTestVisible="False" />
        
        <!-- Header -->
        <Grid Padding="2">

            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="pictureColumn"
                                  Width="{ThemeResource headerPictureColumnWidth}" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <Grid Style="{StaticResource headerPictureGrid}">
                <common:PictureControl x:Name="artistPicture"
                                       Cover="{x:Bind ViewModel.Picture, Mode=OneWay}"
                                       Style="{StaticResource headerPicture}" />
                <Button x:Uid="selectPicture"
                        Style="{StaticResource headerPictureSelectButton}"
                        Command="{x:Bind ViewModel.SelectPictureCommand}" />
            </Grid>

            <RelativePanel Grid.Column="1"
                           Margin="6,0,0,0">
                <TextBlock x:Name="albumName"
                           Text="{x:Bind ViewModel.Album.Name, Mode=OneWay}"
                           Style="{StaticResource headerTitleText}" />

                <HyperlinkButton x:Name="artistName"
                                 Content="{x:Bind ViewModel.Album.ArtistName}"
                                 RelativePanel.Below="albumName"
                                 Margin="0" 
                                 Padding="0"
                                 Command="{x:Bind ViewModel.ArtistOpenCommand}"
                                 Style="{StaticResource headerGenreHyperlink}" />

                <Button x:Name="buttonCountry"
                        RelativePanel.AlignVerticalCenterWith="artistName"
                        RelativePanel.RightOf="artistName"
                        Style="{StaticResource ButtonTextBlockStyle}"
                        Visibility="{x:Bind ViewModel.Album.CountryCode, Converter={StaticResource StringToVisibilityConverter}}"                        
                        BorderBrush="Transparent"
                        Margin="4,0,0,0"
                        Background="Transparent"
                        ToolTipService.ToolTip="{x:Bind ViewModel.Album.CountryName}">
                    <Image Source="{x:Bind ViewModel.Album.CountryCode, Converter={StaticResource CountryCodeToImageSourceConverter}}"
                           Height="{ThemeResource countryFlagHeigh}"></Image>
                </Button>

                <StackPanel x:Name="albumType"
                            RelativePanel.RightOf="albumName"
                            RelativePanel.AlignVerticalCenterWith="albumName"
                            Orientation="Horizontal"
                            Margin="4,0,0,0">
                    <Border Visibility="{x:Bind ViewModel.Album.IsLive, Mode=TwoWay, Converter={StaticResource BoolToVisibilityConverter}}"
                            Background="DarkCyan"
                            CornerRadius="1"
                            Margin="0,0,10,0">
                        <TextBlock Text="Live"
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   Foreground="White"
                                   FontSize="9"
                                   Padding="4,0,4,0" />
                    </Border>

                    <Border Visibility="{x:Bind ViewModel.Album.IsBestOf, Mode=TwoWay, Converter={StaticResource BoolToVisibilityConverter}}"
                            Background="DarkBlue"
                            CornerRadius="1"
                            Margin="0,0,10,0">
                        <TextBlock Text="Bestof"
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   Foreground="White"
                                   FontSize="9"
                                   Padding="4,0,4,0" />
                    </Border>

                    <Border Visibility="{x:Bind ViewModel.Album.IsCompilation, Mode=TwoWay, Converter={StaticResource BoolToVisibilityConverter}}"
                            Background="DarkViolet"
                            CornerRadius="1"
                            Margin="0,0,10,0">
                        <TextBlock Text="Compilation"
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   Foreground="White"
                                   FontSize="9"
                                   Padding="4,0,4,0" />
                    </Border>
                </StackPanel>

                <TextBlock x:Name="panelExtendedInfo"
                           RelativePanel.RightOf="buttonCountry"
                           RelativePanel.AlignBottomWith="artistName"
                           Margin="6,0,0,0"
                           Style="{StaticResource headerText}"
                           Text="{x:Bind ViewModel.SubTitle}">
                    <Run Text="ðŸ”¹" />
                    <Run Text="{x:Bind ViewModel.SubTitle}" />
                </TextBlock>

                <StackPanel x:Name="panelStatsInfo"
                            RelativePanel.Below="panelExtendedInfo"
                            Orientation="Horizontal"
                            Visibility="{x:Bind ViewModel.Album.ListenCount, Converter={StaticResource IntToVisibilityConverter}}">
                    <TextBlock x:Uid="AlbumViewListenCount"
                               Margin="0,0,4,0"
                               FontSize="12"></TextBlock>
                    <TextBlock Text="{x:Bind ViewModel.Album.ListenCount}"
                               FontSize="12"></TextBlock>
                    <TextBlock x:Uid="AlbumViewListenCountTimes"
                               Margin="2,0,0,0"
                               FontSize="12"></TextBlock>

                    <TextBlock x:Uid="AlbumViewLastListen"
                               Margin="0,0,2,0"
                               FontSize="12"></TextBlock>
                    <TextBlock Text="{x:Bind ViewModel.Album.LastListen}"
                               FontSize="12"></TextBlock>
                </StackPanel>

                <StackPanel x:Name="tagsContainer"
                            RelativePanel.Below="panelStatsInfo"
                            Orientation="Horizontal"
                            Spacing="0"
                            Margin="0">

                    <controls:TokenizingTextBox
                                                x:Uid="AlbumTagsBox"
                                                x:Name="AlbumTagsBox"
                                                ItemsSource="{x:Bind ViewModel.Tags, Mode=OneWay}"
                                                SuggestedItemsSource="{x:Bind ViewModel.SuggestedTags, Mode=OneWay}"
                                                PlaceholderText="+ add tag"
                                                TokenDelimiter=","
                                                HorizontalAlignment="Left"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                Margin="0"
                                                MinWidth="150">
                        
                        <controls:TokenizingTextBox.Resources>
                            <Style TargetType="controls:TokenizingTextBoxItem">
                                <Setter Property="Background"
                                        Value="{ThemeResource SystemControlBackgroundBaseLowBrush}" />
                                <Setter Property="Foreground"
                                        Value="{ThemeResource SystemControlForegroundBaseHighBrush}" />
                                <Setter Property="CornerRadius"
                                        Value="2" />
                                <Setter Property="FontSize"
                                        Value="11" />
                                <Setter Property="Padding"
                                        Value="6,2,6,2" />
                                <Setter Property="Margin"
                                        Value="0,0,4,0" />
                                <Setter Property="MinHeight"
                                        Value="24" />
                                <Setter Property="MinWidth"
                                        Value="20" />
                            </Style>
                        </controls:TokenizingTextBox.Resources>
                    </controls:TokenizingTextBox>
                </StackPanel>

                <CommandBar x:Name="panelNetwork"
                            RelativePanel.Below="panelStatsInfo"
                            Margin="-10,-5,0,0"
                            Style="{StaticResource headerCommandBar}">

                    <AppBarButton x:Uid="albumViewLastFm"
                                  Style="{StaticResource headerBrandButton}"
                                  ToolTipService.ToolTip="Last.FM"
                                  Command="{x:Bind ViewModel.OpenUrlCommand, Mode=OneWay}"
                                  CommandParameter="{x:Bind ViewModel.Album.LastFmUrl, Mode=OneWay}"
                                  Visibility="{x:Bind ViewModel.Album.LastFmUrl, Mode=OneWay, Converter={StaticResource StringToVisibilityConverter}}">
                        <Viewbox Width="20"
                                 Height="20"
                                 Stretch="Uniform">
                            <Canvas Width="24"
                                    Height="24">
                                <Path Fill="#D51007"
                                      Data="M10.584 17.21l-.88-2.392s-1.43 1.594-3.573 1.594c-1.897 0-3.244-1.649-3.244-4.288 0-3.382 1.704-4.591 3.381-4.591 2.42 0 3.189 1.567 3.849 3.574l.88 2.749c.88 2.666 2.529 4.81 7.285 4.81 3.409 0 5.718-1.044 5.718-3.793 0-2.227-1.265-3.381-3.63-3.931l-1.758-.385c-1.21-.275-1.567-.77-1.567-1.595 0-.934.742-1.484 1.952-1.484 1.32 0 2.034.495 2.144 1.677l2.749-.33c-.22-2.474-1.924-3.492-4.729-3.492-2.474 0-4.893.935-4.893 3.932 0 1.87.907 3.051 3.189 3.601l1.87.44c1.402.33 1.869.907 1.869 1.704 0 1.017-.99 1.43-2.86 1.43-2.776 0-3.93-1.457-4.59-3.464l-.907-2.75c-1.155-3.573-2.997-4.893-6.653-4.893C2.144 5.333 0 7.89 0 12.233c0 4.18 2.144 6.434 5.993 6.434 3.106 0 4.591-1.457 4.591-1.457z" />
                            </Canvas>
                        </Viewbox>
                    </AppBarButton>
                </CommandBar>

                <CommandBar  RelativePanel.AlignBottomWithPanel="True"
                             RelativePanel.AlignLeftWith="albumName"
                             Style="{StaticResource headerCommandBar}">

                    <AppBarButton x:Uid="albumViewListen"
                                  Style="{StaticResource listenAppBarButtonStyle}"
                                  Command="{x:Bind ViewModel.ListenCommand}" />

                    <AppBarToggleButton x:Uid="albumViewLike"
                                        x:Name="albumAppBarLike"
                                        Style="{StaticResource headerLikeButton}"
                                        IsChecked="{x:Bind ViewModel.IsFavorite, Mode=OneWay}"
                                        Command="{x:Bind ViewModel.AlbumFavoriteCommand}" />
                    
                    <AppBarButton x:Uid="albumViewBiography"
                                  Style="{StaticResource headerGenericButton}"
                                  Icon="Library"
                                  Command="{x:Bind ViewModel.OpenBiographyCommand}"
                                  Visibility="{x:Bind ViewModel.Album.Biography, Converter={StaticResource StringToVisibilityConverter}}" />
                                        
                    <AppBarButton x:Uid="albumViewPlaylist"
                                  Style="{StaticResource headerGenericButton}"
                                  Icon="Add">
                        <AppBarButton.Flyout>
                            <MenuFlyout x:Name="albumPlaylistFlyout"
                                        common:MenuFlyoutExtensions.PlaylistMenuService="{x:Bind ViewModel.PlaylistMenuService}"
                                        common:MenuFlyoutExtensions.AlbumId="{x:Bind ViewModel.Album.Id}"
                                        common:MenuFlyoutExtensions.FlattenPlaylistMenu="True" />
                        </AppBarButton.Flyout>
                    </AppBarButton>

                    <AppBarButton x:Uid="albumViewEdit"
                                  Style="{StaticResource headerGenericButton}"
                                  Icon="Edit"
                                  Command="{x:Bind ViewModel.EditAlbumCommand}" />

                </CommandBar>

            </RelativePanel>
        </Grid>

        <!-- Tracks grid -->
        <Grid x:Name="tracks"
              CornerRadius="12,12,0,0"              
              Background="{ThemeResource CardBackgroundFillColorDefault}"
              Grid.Row="1"
              Margin="4,0,4,4"
              ScrollViewer.VerticalScrollBarVisibility="Auto">

            <Grid.RowDefinitions>
                <RowDefinition Height="{ThemeResource gridHeaderTracksHeight}" />
                <RowDefinition />
            </Grid.RowDefinitions>

            <!-- Grid headers -->
            <Grid Style="{StaticResource gridTracks}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="{ThemeResource gridHeaderTracksTitleColumnWidth}" />
                    <ColumnDefinition Width="{ThemeResource gridHeaderTracksArtistColumnWidth}" />
                    <ColumnDefinition Width="{ThemeResource gridHeaderTracksScoreColumnWidth}" />
                </Grid.ColumnDefinitions>

                <TextBlock x:Uid="gridHeaderTitle"
                           Grid.Column="0"
                           Style="{StaticResource gridHeaderTracksText}" />
                <TextBlock x:Uid="gridHeaderArtist"
                           Grid.Column="1"
                           Visibility="{x:Bind ViewModel.Album.IsCompilation, Converter={StaticResource BoolToVisibilityConverter}}"
                           Style="{StaticResource gridHeaderTracksText}" />
                <TextBlock x:Uid="gridHeaderScore"
                           Grid.Column="2"
                           Style="{StaticResource gridHeaderTracksText}" />
            </Grid>

            <ListView x:Name="tracksList"
                      Grid.Row="1"
                      ContainerContentChanging="tracksList_ContainerContentChanging"
                      ItemsSource="{x:Bind ViewModel.Tracks}"
                      ItemContainerStyle="{StaticResource tracksListViewItem}"
                      SelectionMode="Single">

                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="tracks:TrackViewModel">
                        <Grid Background="Transparent">
                            
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="{ThemeResource gridHeaderTracksTitleColumnWidth}" />
                                <ColumnDefinition Width="{ThemeResource gridHeaderTracksArtistColumnWidth}" />
                                <ColumnDefinition Width="{ThemeResource gridHeaderTracksScoreColumnWidth}" />
                            </Grid.ColumnDefinitions>

                            <Grid.ContextFlyout>
                                <MenuFlyout ShowMode="TransientWithDismissOnPointerMoveAway"
                                            common:MenuFlyoutExtensions.PlaylistMenuService="{x:Bind PlaylistMenuService}"
                                            common:MenuFlyoutExtensions.TrackId="{x:Bind Track.Id}">
                                    <MenuFlyoutItem x:Uid="trackFlyoutListen"
                                                    Icon="Play"
                                                    Command="{x:Bind ListenCommand}"
                                                    CommandParameter="{x:Bind}" />
                                    <MenuFlyoutItem x:Uid="trackFlyoutArtist"
                                                    Icon="People"
                                                    Command="{x:Bind ArtistOpenCommand}" />
                                    <MenuFlyoutItem x:Uid="trackFlyoutTrack"
                                                    Icon="Audio"
                                                    Command="{x:Bind TrackOpenCommand}" />
                                    <MenuFlyoutSeparator />
                                    <MenuFlyoutItem x:Uid="trackFlyoutLyrics"
                                                    Command="{x:Bind LyricsOpenCommand}"
                                                    Visibility="{x:Bind LyricsExists, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <MenuFlyoutItem.Icon>
                                            <FontIcon Glyph="&#xE90B;" />
                                        </MenuFlyoutItem.Icon>
                                    </MenuFlyoutItem>
                                </MenuFlyout>
                            </Grid.ContextFlyout>

                            <StackPanel Grid.Column="0"
                                        Orientation="Horizontal">

                                <TextBlock x:Name="RowIndexText"
                                           Style="{StaticResource gridTracksRowIndexText}" />

                                <HyperlinkButton Style="{StaticResource gridTracksTitleText}"
                                                 Command="{x:Bind ListenCommand}"
                                                 CommandParameter="{x:Bind}" />

                                <HyperlinkButton x:Uid="lyricsTag"
                                                 Visibility="{x:Bind LyricsExists, Converter={StaticResource BoolToVisibilityConverter}}"
                                                 Style="{StaticResource gridTracksLyricsText}"
                                                 Command="{x:Bind LyricsOpenCommand}" />
                            </StackPanel>

                            <HyperlinkButton Grid.Column="1"
                                             Visibility="{x:Bind Track.IsAlbumCompilation, Converter={StaticResource BoolToVisibilityConverter}}"
                                             Style="{StaticResource gridTracksArtistText}"
                                             Command="{x:Bind ArtistOpenCommand}" />

                            <common:RatingControlLightControl Grid.Column="2"
                                                              Style="{StaticResource gridTracksScore}"
                                                              RatingValue="{x:Bind Score, Mode=TwoWay}" />
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>
    </Grid>
</Page>
