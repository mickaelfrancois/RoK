<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="Rok.Pages.PlayerView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Rok.Pages"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:commons="using:Rok.Commons"
    mc:Ignorable="d">

    <UserControl.Resources>

        <Style x:Key="MiniLinkStyle" TargetType="HyperlinkButton">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Normal"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <DataTemplate x:Key="EllipsisTemplate">
            <TextBlock Text="{Binding}"
                   TextTrimming="CharacterEllipsis"
                   VerticalAlignment="Center"/>
        </DataTemplate>

    </UserControl.Resources>

    <Grid HorizontalAlignment="Stretch"
          Padding="4,4,4,4"
          ColumnSpacing="12"
          Background="{ThemeResource SystemControlBackgroundAccentBrush}">

        <Grid Translation="0,0,10">
            <Grid.Shadow>
                <ThemeShadow />
            </Grid.Shadow>
        </Grid>

        <!-- Current track info -->
        <Grid x:Name="currentTrack" Width="500" HorizontalAlignment="Left">
            <VisualStateManager.VisualStateGroups>
                <VisualStateGroup x:Name="visualChangeGroup">
                    <VisualState x:Name="changeTrackTitleAnimation">
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="trackTitle"
                                             From="0"
                                             To="1"
                                             Storyboard.TargetProperty="Opacity"
                                             Duration="0:0:2" />
                        </Storyboard>
                    </VisualState>
                    <VisualState x:Name="changeTrackScoreAnimation">
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="trackScore"
                                             From="0"
                                             To="1"
                                             Storyboard.TargetProperty="Opacity"
                                             Duration="0:0:2" />
                        </Storyboard>
                    </VisualState>
                    <VisualState x:Name="changeTrackArtistAnimation">
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="trackArtist"
                                             From="0"
                                             To="1"
                                             Storyboard.TargetProperty="Opacity"
                                             Duration="0:0:2" />
                        </Storyboard>
                    </VisualState>
                    <VisualState x:Name="changeTrackAlbumAnimation">
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="trackAlbum"
                                             From="0"
                                             To="1"
                                             Storyboard.TargetProperty="Opacity"
                                             Duration="0:0:2" />

                            <DoubleAnimation Storyboard.TargetName="currentTrackCover"
                                             From="0"
                                             To="1"
                                             Storyboard.TargetProperty="Opacity"
                                             Duration="0:0:2" />
                        </Storyboard>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateManager.VisualStateGroups>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="70" x:Name="coverColumn"></ColumnDefinition>
                <ColumnDefinition Width="430" x:Name="trackColumn"></ColumnDefinition>
            </Grid.ColumnDefinitions>

            <Border x:Name="currentTrackCover"
                    Grid.Column="0"
                    CornerRadius="4"
                    Padding="1" 
                    Width="70" 
                    Height="70" 
                    BorderThickness="0"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                <Grid CornerRadius="4"
                      Background="{ThemeResource LayerFillColorDefaultBrush}">
                    <Image Width="70"
                           Height="70"
                           Stretch="UniformToFill"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Source="{x:Bind ViewModel.CurrentAlbum.Picture, Mode=OneWay}">
                        <Image.Transitions>
                            <TransitionCollection>
                                <EntranceThemeTransition />
                            </TransitionCollection>
                        </Image.Transitions>
                    </Image>
                </Grid>
            </Border>

            <Grid x:Name="currentTrackInfo" Grid.Column="1" HorizontalAlignment="Stretch" Height="70">

                <Grid.RowDefinitions>
                    <RowDefinition Height="35"></RowDefinition>
                    <RowDefinition Height="35"></RowDefinition>
                </Grid.RowDefinitions>


                <!--Title line-->
                <StackPanel x:Name="trackTitleLine" Grid.Column="1" Grid.Row="0" Orientation="Horizontal" Margin="6,0,0,0">
                    <HyperlinkButton Grid.Column="0"
                                     x:Name="trackTitle"
                                     HorizontalAlignment="Left"
                                     HorizontalContentAlignment="Left"
                                     MinWidth="100"
                                     MaxWidth="200"
                                     Style="{StaticResource MiniLinkStyle}"
                                     Command="{x:Bind ViewModel.CurrentTrack.TrackOpenCommand, Mode=OneWay}"
                                     Content="{x:Bind ViewModel.CurrentTrack.Title, Mode=OneWay}"
                                     ContentTemplate="{StaticResource EllipsisTemplate}"
                                     ToolTipService.ToolTip="{x:Bind ViewModel.CurrentTrack.Title, Mode=OneWay}"/>

                    <commons:RatingControlDarkControl x:Name="trackScore"
                                   Margin="30,0,0,0" 
                                   HorizontalAlignment="Right"                                                       
                                   InitialValue="{x:Bind ViewModel.CurrentTrack.Score, Mode=OneWay}" 
                                   Value="{x:Bind ViewModel.CurrentTrack.Score, Mode=TwoWay}" 
                                   Width="150" 
                                   VerticalAlignment="Center">
                    </commons:RatingControlDarkControl>
                </StackPanel>

                <!--Track info line-->
                <StackPanel Grid.Column="1" Grid.Row="1" Orientation="Horizontal" Margin="6,0,0,0">
                    <HyperlinkButton Style="{StaticResource MiniLinkStyle}"
                                     x:Name="trackArtist"
                                     MaxWidth="200"
                                     Command="{x:Bind ViewModel.CurrentTrack.ArtistOpenCommand, Mode=OneWay}"
                                     Content="{x:Bind ViewModel.CurrentTrack.ArtistName, Mode=OneWay}"
                                     ContentTemplate="{StaticResource EllipsisTemplate}"
                                     ToolTipService.ToolTip="{x:Bind ViewModel.CurrentTrack.ArtistName, Mode=OneWay}" />

                    <TextBlock Text="â€¢" 
                               Foreground="White" 
                               FontSize="12"
                               VerticalAlignment="Center" Margin="6,0,6,0" />

                    <HyperlinkButton Style="{StaticResource MiniLinkStyle}"
                                     x:Name="trackAlbum"
                                     MaxWidth="200"
                                     Command="{x:Bind ViewModel.CurrentTrack.AlbumOpenCommand, Mode=OneWay}"
                                     Content="{x:Bind ViewModel.CurrentTrack.AlbumName, Mode=OneWay}"
                                     ContentTemplate="{StaticResource EllipsisTemplate}"
                                     ToolTipService.ToolTip="{x:Bind ViewModel.CurrentTrack.AlbumName, Mode=OneWay}" />
                </StackPanel>
            </Grid>
        </Grid>


        <!-- Player controls -->
        <Grid x:Name="playerControls" Width="350" HorizontalAlignment="Center">
            <Grid.RowDefinitions>
                <RowDefinition Height="50"></RowDefinition>
                <RowDefinition></RowDefinition>
            </Grid.RowDefinitions>


            <!--Current track progression-->
            <Grid x:Name="trackProgression" VerticalAlignment="Center" Grid.Row="1" Margin="0" Padding="0" Height="38" Width="350">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="60"></ColumnDefinition>
                    <ColumnDefinition Width="230"></ColumnDefinition>
                    <ColumnDefinition Width="60"></ColumnDefinition>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" 
                           Text="{x:Bind ViewModel.ListenDurationStr, Mode=OneWay}" 
                           Foreground="White" 
                           HorizontalAlignment="Right" 
                           Margin="0,0,10,0"                            
                           VerticalAlignment="Center" 
                           FontSize="14" />

                <Slider x:Name="slider" 
                        Grid.Column="1" 
                        Margin="0,2,0,0"
                        VerticalAlignment="Center" 
                        Width="230"                                
                        Value="{x:Bind ViewModel.ListenDuration, Mode=OneWay, Converter={StaticResource TimeSpanToDoubleConverter}}"
                        Maximum="{x:Bind ViewModel.DurationTotal, Mode=OneWay, Converter={StaticResource TimeSpanToDoubleConverter}}"                       
                        ThumbToolTipValueConverter="{StaticResource DoubleToTimespanConverter}"                        
                        IsThumbToolTipEnabled="True"                        
                        LargeChange="7" 
                        SmallChange="5"  
                        PointerCaptureLost="Slider_PointerCaptureLost" 
                        ManipulationStarted="Slider_ManipulationStarted" 
                        ManipulationMode="All" />

                <TextBlock Grid.Column="2"
                           Text="{x:Bind ViewModel.DurationTotalStr, Mode=OneWay}" 
                           Foreground="White" 
                           HorizontalAlignment="Left" 
                           Margin="10,0,0,0" 
                           VerticalAlignment="Center" 
                           FontSize="14" />
            </Grid>


            <!-- Player commands -->
            <Grid Grid.Row="0" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="0" Width="350">
                <CommandBar VerticalAlignment="Center" HorizontalAlignment="Center" Background="Transparent" IsDynamicOverflowEnabled="False" OverflowButtonVisibility="Collapsed">
                    <AppBarButton Icon="Previous" 
                                  Command="{x:Bind ViewModel.SkipPreviousCommand}" 
                                  IsEnabled="{x:Bind ViewModel.CanSkipPrevious, Mode=OneWay}"   
                                  Foreground="White" 
                                  VerticalAlignment="Stretch"
                                  Height="65"
                                  Width="40"
                                  Margin="0,0,0,0" />

                    <AppBarButton Command="{x:Bind ViewModel.TogglePlayPauseCommand}" 
                                  Foreground="White" 
                                  Margin="10,0,0,0"
                                  Style="{StaticResource RoundAppBarButtonStyle}">
                        <SymbolIcon Symbol="{x:Bind ViewModel.PlaybackState, Mode=OneWay, Converter={StaticResource PlaybackStateToButtonIconConverter}}"/>
                    </AppBarButton>

                    <AppBarButton Icon="Next" 
                                  Command="{x:Bind ViewModel.SkipNextCommand}" 
                                  IsEnabled="{x:Bind ViewModel.CanSkipNext, Mode=OneWay}" 
                                  Foreground="White"                                  
                                  VerticalAlignment="Stretch"
                                  Height="65"
                                  Width="40"
                                  Margin="10,0,0,0" />
                </CommandBar>
            </Grid>
        </Grid>


        <!-- Player extra commands -->
        <Grid x:Name="playerCommands" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,4,0" Width="300" Visibility="Visible" >
            <CommandBar HorizontalAlignment="Right" Background="Transparent" OverflowButtonVisibility="Collapsed">
                
                <AppBarButton Icon="MusicInfo" 
                              Command="{x:Bind ViewModel.OpenListeningCommand}" 
                              Foreground="White">

                    <ToolTipService.ToolTip>
                        <TextBlock x:Uid="PlayerCurrentListeningToolTips" Text="Show current playlist"/>
                    </ToolTipService.ToolTip>
                </AppBarButton>

                <AppBarButton x:Name="volume" Foreground="White">
                    <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="{x:Bind ViewModel.Volume, Mode=OneWay, Converter={StaticResource VolumeToGlyphConverter}}" />
                    <AppBarButton.Flyout>
                        <Flyout>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <Button Margin="0,0,4,0" Command="{x:Bind ViewModel.MuteCommand}" Background="Transparent">
                                    <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="{x:Bind ViewModel.Volume, Mode=OneWay, Converter={StaticResource VolumeToGlyphConverter}}" />
                                </Button>
                                <Slider Width="200" Value="{x:Bind ViewModel.Volume, Mode=TwoWay}" Minimum="0" Maximum="100"></Slider>
                            </StackPanel>
                        </Flyout>
                    </AppBarButton.Flyout>
                </AppBarButton>

                <AppBarButton x:Name="btCompactMode" Command="{x:Bind ViewModel.CompactModeCommand}" Foreground="White">
                    <ToolTipService.ToolTip>
                        <TextBlock x:Uid="PlayerCompactModeToolTips" Text="Compact mode."></TextBlock>
                    </ToolTipService.ToolTip>
                    <SymbolIcon Symbol="StopSlideShow"/>
                </AppBarButton>

                <AppBarButton Command="{x:Bind ViewModel.FullscreenCommand}" Foreground="White">
                    <ToolTipService.ToolTip>
                        <TextBlock x:Uid="PlayerFullscreenToolTips" Text="Full screen mode."></TextBlock>
                    </ToolTipService.ToolTip>
                    <SymbolIcon Symbol="FullScreen"></SymbolIcon>
                </AppBarButton>
            </CommandBar>
        </Grid>

    </Grid>
</UserControl>